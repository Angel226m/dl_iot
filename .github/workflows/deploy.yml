name: CI/CD Pipeline para CrackGuard IoT

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build-images:
    name: Build Docker Images
    runs-on: ubuntu-latest
    if: github.event_name == 'push'

    steps:
      - name: Checkout código
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build Frontend Image
        run: |
          cd Frontend
          docker build -t crackguard-frontend:latest . || echo "Advertencia: Frontend build con warnings"

      - name: Build Backend Image
        run: |
          cd Backend
          docker build -t crackguard-backend:latest . || echo "Advertencia: Backend build con warnings"

      - name: Verificar imágenes creadas
        run: |
          docker images | grep crackguard

  deploy:
    name: Deploy to Production
    needs: build-images
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout código
        uses: actions/checkout@v3

      - name: Configurar SSH
        run: |
          mkdir -p ~/.ssh/
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts

      - name: Verificar conexión SSH
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} "echo 'Conexión SSH exitosa'"

      - name: Crear directorio de proyecto
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} \
            "mkdir -p /home/${{ secrets.SERVER_USER }}/crackguard-iot"

      - name: Transferir archivos al servidor
        run: |
          rsync -avz -e "ssh -i ~/.ssh/id_rsa" \
            --exclude 'node_modules' \
            --exclude '.git' \
            --exclude 'Backend/__pycache__' \
            --exclude 'Backend/uploads' \
            --exclude 'Backend/results' \
            --exclude 'Frontend/dist' \
            --exclude 'Frontend/.vite' \
            --exclude 'Frontend/node_modules' \
            ./ ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }}:/home/${{ secrets.SERVER_USER }}/crackguard-iot/

      - name: Detener contenedores anteriores
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} \
            "cd /home/${{ secrets.SERVER_USER }}/crackguard-iot && docker compose down || true"

      - name: Limpiar imágenes antiguas
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} "docker image prune -f"

      - name: Desplegar nuevos contenedores
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} \
            "cd /home/${{ secrets.SERVER_USER }}/crackguard-iot && docker compose up -d --build --force-recreate"

      - name: Esperar inicio
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} "sleep 20"

      - name: Verificar contenedores
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} \
            "docker compose -f /home/${{ secrets.SERVER_USER }}/crackguard-iot/docker-compose.yml ps"

      - name: Verificar logs backend
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} \
            "docker logs crackguard-backend --tail 50"

      - name: Verificar logs frontend
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} \
            "docker logs crackguard-frontend --tail 30"

      - name: Health check backend
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} \
            "curl -f http://localhost:5001/health && echo 'Backend OK' || echo 'Backend no responde'"

      - name: Health check frontend
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} \
            "curl -f http://localhost:3001/ && echo 'Frontend OK' || echo 'Frontend no responde'"

      - name: Recargar Nginx
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} \
            "docker exec nginx-proxy nginx -s reload || echo 'Nginx no disponible'"

      - name: Despliegue exitoso
        run: |
          echo "¡CRACKGUARD DESPLEGADO!"
          echo "Frontend: https://crackguard.angelproyect.com"
          echo "API: https://crackguard.angelproyect.com/api/health"

  notify:
    name: Notificar resultado
    needs: deploy
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: Resultado final
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "DESPLIEGUE EXITOSO"
            echo "CrackGuard v4.2 LIVE"
          else
            echo "FALLÓ EL DEPLOY"
            echo "Revisa los logs arriba"
          fi