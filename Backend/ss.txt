#!/usr/bin/env python3
"""
游꿘 RASPBERRY PI CAMERA - CLIENTE WEBSOCKET CRACKGUARDd
Conecta con: wss://crackguard.angelproyect.com/ws/raspberry
"""

import json
import time
import base64
import cv2
from picamera2 import Picamera2
from websocket import create_connection, WebSocketException
import threading
 

WEBSOCKET_URL = "wss://crackguard.angelproyect.com/ws/raspberry"
DEVICE_ID = "rpi4-cam-angel"  # ID 칰nico de tu Raspberry
RECONNECT_DELAY = 5  # Segundos entre reintentos

# Configuraci칩n de c치mara optimizada
picam2 = Picamera2()
config = picam2.create_video_configuration(
    main={"size": (1280, 720), "format": "RGB888"},
    controls={"FrameRate": 25}
)
picam2.configure(config)

picam2.set_controls({
    "AwbEnable": True,
    "AeEnable": True,
    "Brightness": 0.25,
    "Contrast": 1.45,
    "Saturation": 1.1,
    "Sharpness": 1.8,
    "NoiseReductionMode": 4,
    "AeConstraintMode": 0,
    "AeExposureMode": 0,
    "AnalogueGain": 2.2
})
 

def tomar_foto():
    """Captura una foto optimizada y devuelve base64"""
    try:
        print("Capturando foto...")
        frame = picam2.capture_array()
        
        # Aplicar filtro anti-ruido seg칰n luminosidad
        brightness = frame.mean()
        if brightness < 80:
            frame = cv2.bilateralFilter(frame, 7, 50, 50)
        else:
            frame = cv2.bilateralFilter(frame, 5, 35, 35)
        
        # Convertir RGB a BGR para OpenCV
        frame_bgr = cv2.cvtColor(frame, cv2.COLOR_RGB2BGR)
        
        # Codificar como JPEG (calidad 92%)
        _, buffer = cv2.imencode('.jpg', frame_bgr, [cv2.IMWRITE_JPEG_QUALITY, 92])
        
        # Convertir a base64
        image_b64 = base64.b64encode(buffer).decode('utf-8')
        
        print(f" Foto capturada: {len(image_b64)} bytes (base64)")
        return image_b64
        
    except Exception as e:
        print(f" Error al tomar foto: {e}")
        return None

def iniciar_streaming():
    """Inicia el servidor de streaming local (puerto 8080)"""
    import subprocess
    print(" Iniciando servidor de streaming en puerto 8080...")
    # Aqu칤 puedes ejecutar tu script de streaming actual en segundo plano
    # Por ahora, asumimos que ya est치 corriendo



def conectar_websocket():
    """Conexi칩n persistente con reconexi칩n autom치tica"""
    ws = None
    
    while True:
        try:
            print(f"\n{'='*70}")
            print(f" Conectando a: {WEBSOCKET_URL}")
            print(f" Device ID: {DEVICE_ID}")
            print(f"{'='*70}")
            
            ws = create_connection(WEBSOCKET_URL, timeout=10)
            
            # Registrar dispositivo
            registro = {
                "event": "register",
                "data": {
                    "device_id": DEVICE_ID,
                    "type": "raspberry_pi_camera",
                    "capabilities": ["photo", "streaming"],
                    "ip_local": "192.168.1.44"
                }
            }
            ws.send(json.dumps(registro))
            print(f"Registrado como: {DEVICE_ID}")
            
            # Loop de recepci칩n de comandos
            while True:
                try:
                    mensaje = ws.recv()
                    
                    if not mensaje:
                        print(" Conexi칩n cerrada por el servidor")
                        break
                    
                    data = json.loads(mensaje)
                    event = data.get("event", "command")
                    payload = data.get("data", data)
                    
                    print(f"\n Comando recibido: {event}")
                    print(f"   Payload: {payload}")
                    
                 
                    
                    if event == "command":
                        action = payload.get("action")
                        
                        # TOMAR FOTO
                        if action == "take_photo":
                            image_b64 = tomar_foto()
                            
                            if image_b64:
                                respuesta = {
                                    "event": "photo_result",
                                    "data": {
                                        "device_id": DEVICE_ID,
                                        "image": image_b64,
                                        "timestamp": time.time(),
                                        "metadata": {
                                            "resolution": "1280x720",
                                            "format": "JPEG",
                                            "quality": 92
                                        }
                                    }
                                }
                                ws.send(json.dumps(respuesta))
                                print(" Foto enviada al servidor")
                            else:
                                error_msg = {
                                    "event": "error",
                                    "data": {
                                        "device_id": DEVICE_ID,
                                        "error": "No se pudo capturar la foto"
                                    }
                                }
                                ws.send(json.dumps(error_msg))
                        
                        # OBTENER URL DE STREAMING
                        elif action == "get_stream_url":
                            respuesta = {
                                "event": "stream_url",
                                "data": {
                                    "device_id": DEVICE_ID,
                                    "url": "http://192.168.1.44:8080/video_feed",
                                    "status": "active"
                                }
                            }
                            ws.send(json.dumps(respuesta))
                            print("URL de streaming enviada")
                        
                        # 游댢 AJUSTAR CONFIGURACI칍N
                        elif action == "set_config":
                            config_params = payload.get("params", {})
                            print(f"丘뙖잺  Ajustando configuraci칩n: {config_params}")
                            # Aqu칤 puedes ajustar par치metros de la c치mara
                            respuesta = {
                                "event": "config_updated",
                                "data": {
                                    "device_id": DEVICE_ID,
                                    "status": "ok"
                                }
                            }
                            ws.send(json.dumps(respuesta))
                        
                        #  COMANDO DESCONOCIDO
                        else:
                            print(f"  Comando desconocido: {action}")
                    
                    #  PING/PONG (keep-alive)
                    elif event == "ping":
                        pong = {
                            "event": "pong",
                            "data": {"device_id": DEVICE_ID, "timestamp": time.time()}
                        }
                        ws.send(json.dumps(pong))
                    
                except WebSocketException as e:
                    print(f" Error WebSocket: {e}")
                    break
                except json.JSONDecodeError as e:
                    print(f" Error al decodificar JSON: {e}")
                    continue
                except Exception as e:
                    print(f" Error inesperado: {e}")
                    break
        
        except Exception as e:
            print(f" Error de conexi칩n: {e}")
        
        finally:
            if ws:
                try:
                    ws.close()
                except:
                    pass
            
            print(f"\n Reintentando en {RECONNECT_DELAY} segundos...")
            time.sleep(RECONNECT_DELAY)


if __name__ == '__main__':
    print("\n" + "="*70)
    print("   RASPBERRY PI CAMERA - CLIENTE WEBSOCKET")
    print("="*70)
    print(f"   URL: {WEBSOCKET_URL}")
    print(f"   Device ID: {DEVICE_ID}")
    print(f"   Streaming local: http://192.168.1.44:8080")
    print(f"   Reconexi칩n autom치tica: {RECONNECT_DELAY}s")
    print("="*70 + "\n")
    
    # Inicializar c치mara
    print(" Iniciando c치mara...")
    picam2.start()
    time.sleep(2)
    print("C치mara lista\n")
    
    # Conectar WebSocket
    try:
        conectar_websocket()
    except KeyboardInterrupt:
        print("\n\nDeteniendo cliente...")
        picam2.stop()
        print("Cliente detenido correctamente")